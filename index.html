<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WeWork Sticker</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="manifest" href="manifest.webmanifest">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="TemplateData/style.css">
    <link rel="stylesheet" href="TemplateData/custom/customSNS.css">
    <style>
            body { font-family: 'Roboto', sans-serif; letter-spacing: 0.05em; font-size: max(2vw, 2vh); color:white}
      button {height:max(5vw, 5vh);font-size: max(2vw, 2vh);font-weight: bold; border-radius: max(1.5vw, 1.5vh); padding-left: max(5vw, 5vh); padding-right: max(5vw, 5vh); border: 0; color: #62a7fe; background: #3d3d3d; transition:0.1s;user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
      button:hover { filter: brightness(1.15)}
      button:active { transform: scale(0.95); filter: brightness(0.85)}
      .ctaDiv { display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; left: 0; right: 0; top: 0; bottom: 0; background: #2f2e32aa; z-index: 99; transition: 0.5s;}
      #videoButtonsContainer { display:flex; width:100%; align-items: center; justify-content:center; padding: 10px; }
      /* Style for icon buttons */
      #videoButtonsContainer button { background: transparent;  }
      
    </style>
  </head>
  <body>
    <script src="https://libs.zappar.com/zappar-videorecorder/1.0.1/zappar-videorecorder.js"></script>
    <script src="https://libs.zappar.com/zappar-sharing/1.1.8/zappar-sharing.min.js"></script>
    <!--IMAGETARGETS-->
		<imagetarget id='277669660_345342630984036_6427493968813754284_n' src='targets/277669660_345342630984036_6427493968813754284_n.png'></imagetarget>
		<imagetarget id='1' src='targets/1.jpg'></imagetarget>
		<imagetarget id='1' src='targets/1.jpg'></imagetarget>
		<imagetarget id='2' src='targets/2.jpg'></imagetarget>
		<imagetarget id='3' src='targets/3.jpg'></imagetarget>
		<imagetarget id='277669660_345342630984036_6427493968813754284_n' src='targets/277669660_345342630984036_6427493968813754284_n.png'></imagetarget>
		<imagetarget id='1' src='targets/1.jpg'></imagetarget>
		<imagetarget id='2' src='targets/2.jpg'></imagetarget>
		<imagetarget id='3' src='targets/3.jpg'></imagetarget>
		<imagetarget id='Filteryou' src='targets/Filteryou.png'></imagetarget>
		<imagetarget id='srickermumbai' src='targets/sricker mumbai.png'></imagetarget>

    <video id="webcam-video" muted autoplay playsinline style="width:1px;position:absolute"></video>
    <canvas id="video-canvas" style="width:100%; height:100%; object-fit:cover; position:absolute"></canvas>
    <div id="startARDiv" class="ctaDiv" style="background: #2f2e32">
      <select id="chooseCamSel" style="visibility: hidden; background: transparent; border: .05vh solid white; border-radius: max(0.5vw, 0.5vh); color:white; font-size: max(1.5vw, 1.5vh); position: absolute; bottom: 80px" 
        onchange="SelectCam()"></select>
      <p style="text-align: center; width:min(60vw, 60vh);">This augmented reality experience requires access to your device's camera and motion sensors</p>
      <button id="startARButton" onclick="StartAR()" style="visibility: hidden">ALLOW ACCESS</button>
      <br><br><br>
    </div>
    <div id="cameraButtonContainer" style="display:none">
      <div id="tap-container">
        <img src="tap.png" alt="Tap">
    </div>
      <button id="recordButton" aria-label="Record"  >
         <div class="progress-ring">
            <svg class="progress-ring__circle" width="80" height="80" viewBox="0 0 80 80">
              <circle class="progress-ring__track" cx="40" cy="40" r="36"></circle>
              <circle class="progress-ring__bar" cx="40" cy="40" r="36"></circle>
            </svg>
             <div class="camera-icon">
               <div class="red-dot"></div>
               <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="currentColor" viewBox="0 0 16 16">
                <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/>
                  <path d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2H2zm6 8a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                </svg>
               </div>
            </div>
      </button>
  </div>
  <div id="screenshotDiv" style="visibility: hidden; opacity: 0;" class="ctaDiv">
    <div style="position:relative; background-color:#2c2b2f; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25); border-radius: max(1.5vh, 1.5vw); text-align: center; overflow: hidden"> 
      <img id="screenshotImg" src="" alt="screenshot" style="width:80vw; height:80vh">
      <button onclick="HideScreenshot()" style="position:absolute;right: max(1vw, 1vh);top: max(1vw, 1vh);background: #3d3d3d77; width: max(4vw, 4vh); height: max(4vw, 4vh);padding: 0;border-radius: 100vw; display: flex;align-items: center;justify-content: center;">
        <svg width="max(2.5vw,2.5vh)" height="max(2.5vw,2.5vh)" viewBox="0 0 24 24">
          <line x1="3" y1="3" x2="21" y2="21" stroke="#999" stroke-width="2.5"></line>
          <line x1="3" y1="21" x2="21" y2="3" stroke="#999" stroke-width="2.5"></line>
        </svg>
      </button> 
      <p style="font-size: max(1vw, 1vh); color: #fff6" >Press and hold to save or share this screenshot</p>
      </div>
</div>
<div id="videoPreviewDiv" style="visibility: hidden; opacity: 0;" class="ctaDiv">
  <div style="position:relative; background-color:#2c2b2f00; box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.4), 0 12px 30px 0 rgba(0, 0, 0, 0.3); border-radius: max(2vh, 2vw); text-align: center; overflow: hidden; ">
        <video id="videoPreview" controls style="width:80vw; height:80vh; border-radius: max(1vh, 1vw) max(1vh, 1vw) 0 0;"></video>
     <button onclick="HideVideoPreview()" style="position:absolute;right: max(1vw, 1vh);top: max(1vw, 1vh);background: #3d3d3d77; width: max(4vw, 4vh); height: max(4vw, 4vh);padding: 0;border-radius: 100vw; display: flex;align-items: center;justify-content: center; transition: 0.2s; border: 0;">
      <svg width="max(2.5vw,2.5vh)" height="max(2.5vw,2.5vh)" viewBox="0 0 24 24">
        <line x1="3" y1="3" x2="21" y2="21" stroke="#aaa" stroke-width="2.5"></line>
        <line x1="3" y1="21" x2="21" y2="3" stroke="#aaa" stroke-width="2.5"></line>
      </svg>
    </button>
    </div>
    <div id="videoButtonsContainer" style="display:flex; width:100%; align-items: center; justify-content:center; padding: 10px;">
      <button id="saveVideoButton" onclick="downloadVideo()" 
           style="margin-right:5px; background-image: url('save.png'); 
           background-size: contain; background-repeat: no-repeat; 
           background-position: center; /* Add This Line */
           width: max(4.5vw, 4.5vh); height: max(4.5vw, 4.5vh);  
           transition: 0.2s; user-select:none; -webkit-user-select:none;
           -moz-user-select:none; -ms-user-select:none;  letter-spacing: 0.05em; 
           border: 0;  "></button>
      <button onclick="shareVideo()" 
          style="margin-left:5px; background-image: url('share.png'); 
          background-size: contain; background-repeat: no-repeat;  
          background-position: center; /* Add This Line */
          width: max(4.5vw, 4.5vh); height: max(4.5vw, 4.5vh); 
          transition: 0.2s;user-select:none; -webkit-user-select:none; 
          -moz-user-select:none; -ms-user-select:none;  letter-spacing: 0.05em; 
          border: 0;"></button>
  </div>
</div>
    <div id="confirmUrlDiv" style="visibility: hidden; opacity: 0;" class="ctaDiv">
        <div style="position:relative; background-color:#2c2b2f; padding:10px; box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.3), 0 6px 20px 0 rgba(0, 0, 0, 0.25); width: min(80vw,80vh); display:flex; flex-direction: column; align-items: center; border-radius: 1.5vh;
">
            <p id="confirmUrlText" style="text-align: center; width:80%; overflow: hidden; text-overflow: ellipsis;">Are you sure you want to visit url.com?</p>
            <div style="width: 100%">
                <button style="width: 100%; margin-bottom: 15px;" onclick="window.open(newUrlString, '_blank').focus(); HideConfirmUrl()">VISIT SITE</button>
                <button style="width: 100%" onclick="HideConfirmUrl()">GO BACK</button>
            </div>
        </div>
    </div>
    <div id="errorDiv" class="ctaDiv" style="visibility: hidden; opacity: 0; background-color:#2c2b2f">
        <p id="errorText" style="text-align: center; width:60vw; color:#7f3f3f; font-size: max(3vw, 3vh);"></p>
    </div>
    <div id="unity-container">
      <canvas id="unity-canvas" width=250 height=512 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
        <div id="logo-container">
          <img src="weworklogo.png" alt="Logo">
      </div>
        <div id="madeby-container">
          <img src="madeby.png" alt="Made By">
      </div>
      </div>
      <div id="unity-warning"> </div>
</div>
    <script src="arcamera.js" type="text/javascript"></script>
    <script src="itracker.js" type="text/javascript"></script>
    <script src="TemplateData/custom/sns_custom.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QJR77L2KVZ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QJR77L2KVZ');
</script>
    
<script>
  // Disable troublesome gestures
  document.addEventListener('touchstart', function (event) {
    if (event.touches.length > 1) {
      event.preventDefault(); // Prevent pinch-zoom
    }
  }, { passive: false });
  let lastTouchEnd = 0;
  document.addEventListener('touchend', function (event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) { // Detect double-tap
      event.preventDefault();
    }
    lastTouchEnd = now;
  }, false);
  document.addEventListener('gesturestart', function (event) {
    event.preventDefault(); // Prevent gesture zoom
  });
  // --- Global Variables ---
  var unityCanvas = document.querySelector("#unity-canvas");
  var videoCanvas = document.querySelector("#video-canvas");
  var container = document.querySelector("#unity-container");
  var loadingBar = document.querySelector("#unity-loading-bar");
  var progressBarFull = document.querySelector("#unity-progress-bar-full");
  var warningBanner = document.querySelector("#unity-warning");
  var startARDiv = document.querySelector("#startARDiv");
  var startARButton = document.getElementById("startARButton");
  var chooseCamSel = document.getElementById("chooseCamSel");
  var recordButtonContainer = document.getElementById("cameraButtonContainer");
  var tapContainer = document.getElementById("tap-container");
  let unityInstance = null; // Use let for reassignment
  let unityInstanceLoaded = false;
  let tempStream = null; // Holds stream acquired during StartAR for iOS fix
  let permissionsGranted = false; // Track permission state
  // Default Facing Mode and Webcam Settings
		window.unityFacingMode = "environment"
  window.WEBCAM_SETTINGS = {
      video: {
          facingMode: window.unityFacingMode,
          width: { ideal: 1280 }, // Request HD-ish resolution
          height: { ideal: 720 }
          // deviceId will be added if selected from dropdown
      },
      audio: false // Request only video initially for permission prompt simplicity
  };
  // --- Initialization ---
  var initialize = async() => {
    window.arCamera = new ARCamera(unityCanvas, videoCanvas);
    window.iTracker = new ImageTracker(arCamera);
    try{
        await window.iTracker.initialize("./opencv.js");
        console.log("ImageTracker initialized!");
    }
    catch(error){
        console.error("Failed to initialize ImageTracker. Are you missing opencv.js? " + error);
        ShowError("Failed to initialize the experience.");
        return;
    }
    await LoadWebcams(); // Populate camera dropdown
    startARButton.style.visibility = "visible"; // Show button only after init
    // Check initial permission state *without* prompting
    permissionsGranted = await IsCameraPermissionGranted();
    console.log("Initial camera permission state:", permissionsGranted);
  }
  // --- Unity Loading and Startup ---
  async function StartAR() { // Made async
      // Disable UI immediately
      startARButton.disabled = true;
      chooseCamSel.disabled = true;
      startARButton.style.opacity = 0.5; // Visual feedback
      console.log("StartAR clicked. Requesting camera permission first...");
      try {
          // *** iOS Fix: Request camera permission directly tied to the click ***
          console.log("Requesting getUserMedia with settings:", JSON.stringify(window.WEBCAM_SETTINGS));
          tempStream = await navigator.mediaDevices.getUserMedia(window.WEBCAM_SETTINGS);
          console.log("Webcam access granted directly within StartAR.");
          permissionsGranted = true; // Update state
          // Permission granted: Hide start UI, show loading bar
          startARDiv.style.opacity = 0;
          loadingBar.style.display = "block";
          // Visibility handled by CSS transition rule
          // Proceed to load Unity
          var buildUrl = "Build";
          var loaderUrl = buildUrl + "/savenshare.loader.js";
          var config = {
            dataUrl: buildUrl + "/savenshare.data",
            frameworkUrl: buildUrl + "/savenshare.framework.js",
            codeUrl: buildUrl + "/savenshare.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "DefaultCompany",
            productName: "WeWork Sticker",
            productVersion: "0.1",
            showBanner: unityShowBanner,
          };
          // Mobile viewport adjustments
          if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
            var meta = document.querySelector('meta[name="viewport"]'); // Check if exists
            if (!meta) { // Add if not present
                meta = document.createElement('meta');
                meta.name = 'viewport';
                document.getElementsByTagName('head')[0].appendChild(meta);
            }
             meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
          }
          // Load Unity script
          var script = document.createElement("script");
          script.src = loaderUrl;
          script.onload = () => {
            createUnityInstance(unityCanvas, config, (progress) => {
              progressBarFull.style.width = 100 * progress + "%";
            }).then((instance) => {
              // --- Unity Loaded Successfully ---
              loadingBar.style.display = "none";
              unityInstanceLoaded = true;
              window.unityInstance = instance; // Assign to global scope
              console.log("Unity Instance created successfully.");
              // Prepare record button (will be shown by StartWebcam)
              const recordButton = document.getElementById('recordButton');
              if (recordButton) recordButton.classList.add('ready');
              onUnityLoaded(); // Call custom function
              // Unity will call StartWebcam next via SendMessage
            }).catch((message) => {
              // --- Unity Loading Failed ---
              console.error("Unity Instance creation failed:", message);
              ShowError("Failed to load the experience. " + message);
              loadingBar.style.display = "none";
              // Re-enable button for retry?
              startARButton.disabled = false;
              startARButton.style.opacity = 1;
              chooseCamSel.disabled = false;
              startARDiv.style.opacity = 1; // Show start div again
              // Clean up stream if Unity load failed
              if (tempStream) {
                 tempStream.getTracks().forEach(track => track.stop());
                 tempStream = null;
              }
            });
          };
          document.body.appendChild(script);
      } catch (err) {
          // --- getUserMedia Failed ---
          console.error("getUserMedia error within StartAR - ", err.name, err.message);
          let errorMsg = "Camera permission is required.";
           if (err.name === "NotAllowedError") {
               errorMsg = "Camera permission was denied. Please grant permission in your browser settings.";
           } else if (err.name === "NotFoundError") {
               errorMsg = "No camera found, or the selected camera is unavailable.";
           } else if (err.name === "NotReadableError") {
               errorMsg = "Camera might be already in use by another application.";
           } else {
               errorMsg = "Could not access the camera. Error: " + err.name;
           }
          ShowError("Failed to start: " + errorMsg);
          // Re-enable the button and dropdown
          startARButton.disabled = false;
          startARButton.style.opacity = 1;
          chooseCamSel.disabled = false;
          tempStream = null; // Ensure tempStream is null
          permissionsGranted = false;
      }
  }
  function onUnityLoaded(){
      console.log("Unity has finished loading its assets.");
      // Potential place for other setup after Unity is ready but before webcam starts
  }
  // --- Webcam Management ---
  async function StartWebcam(){
      console.log("StartWebcam called (likely by Unity)");
      const video = document.querySelector("#webcam-video");
      if (!video) {
          console.error("webcam-video element not found!");
          if(unityInstance) unityInstance.SendMessage('ARCamera', 'OnStartWebcamFail');
          return;
      }
      try {
          // Check if we already have a stream from the initial permission grant (iOS Fix)
          if (tempStream) {
              console.log("Using pre-acquired stream from StartAR.");
              window.webcamStream = tempStream;
              tempStream = null; // Consume the temporary stream
          } else if (permissionsGranted) {
              // If no tempStream, but permission was known to be granted, request it now
              // (e.g., page reload after permission granted, or if StartAR somehow didn't keep the stream)
              console.log("No pre-acquired stream, requesting getUserMedia again (permission previously granted). Settings:", JSON.stringify(window.WEBCAM_SETTINGS));
               window.webcamStream = await navigator.mediaDevices.getUserMedia(window.WEBCAM_SETTINGS);
              console.log("getUserMedia successful in StartWebcam.");
          } else {
              // This case shouldn't normally happen if StartAR logic is correct
              console.error("StartWebcam called but no pre-acquired stream and permission not granted.");
               throw new Error("Camera permission not available when StartWebcam was called.");
          }
          // Proceed if we have a stream
          if(window.webcamStream) {
              video.srcObject = window.webcamStream;
              // Wait for video metadata to load (important for dimensions/aspect ratio)
               await new Promise((resolve, reject) => {
                   video.onloadedmetadata = resolve;
                   video.onerror = reject; // Handle potential video errors
                   // Add a timeout?
                   // setTimeout(() => reject(new Error("Video metadata load timed out")), 5000);
                   video.play().catch(reject); // Play is often needed for metadata on some browsers
               });
               console.log(`Video metadata loaded. Dimensions: ${video.videoWidth}x${video.videoHeight}`);
              // Start AR Camera processing
               await arCamera.startWebcam(video);
              console.log("Webcam started successfully via arCamera.");
              // Notify Unity
              if(unityInstance) {
                  unityInstance.SendMessage('ARCamera', 'OnStartWebcamSuccess');
                  unityInstance.SendMessage('ARCamera', 'LoadingComplete'); // Confirm loading/startup complete
              }
              // Show record button container now that camera is running
              if(recordButtonContainer){
                  recordButtonContainer.style.display = "block"; // Make it take space
                  setTimeout(() => { recordButtonContainer.style.opacity = 1; }, 50); // Fade in
              } else {
                 console.error("Could not find cameraButtonContainer to make it visible");
              }
              // Ensure Unity canvas is transparent for AR view
              if (unityCanvas) {
                  unityCanvas.style.background = 'transparent';
                  console.log("Set Unity canvas background to transparent.");
              } else {
                  console.error("Could not find #unity-canvas to set background.");
              }
          } else {
               console.error("Webcam stream is null or undefined after attempting to acquire.");
               throw new Error("Failed to obtain webcam stream.");
          }
      } catch (err) {
          console.error("Error during StartWebcam: ", err.name, err.message);
          if(unityInstance) unityInstance.SendMessage('ARCamera', 'OnStartWebcamFail');
          ShowError("Error starting camera: " + err.message);
          // Clean up any potentially lingering stream
          if (window.webcamStream) {
              window.webcamStream.getTracks().forEach(track => track.stop());
              window.webcamStream = null;
          }
           if (tempStream) { // Also cleanup tempStream if error occurred before consumption
              tempStream.getTracks().forEach(track => track.stop());
              tempStream = null;
           }
      }
  }
  async function LoadWebcams(){
      let camDevices = [];
      try {
          let devices = await navigator.mediaDevices.enumerateDevices();
          devices.forEach(mediaDevice => {
              if (mediaDevice.kind === 'videoinput') {
                  camDevices.push(mediaDevice);
              }
          });
          // Clear existing options
          chooseCamSel.innerHTML = '';
          if (camDevices.length > 0) {
              // Try to put preferred facing mode first if possible (heuristic)
              camDevices.sort((a, b) => {
                  let scoreA = 0;
                  let scoreB = 0;
                  const labelA = a.label.toLowerCase();
                  const labelB = b.label.toLowerCase();
                  const preferredFacing = window.unityFacingMode; // 'environment' or 'user'
                  if (preferredFacing === 'environment' && labelA.includes('back')) scoreA = 1;
                  if (preferredFacing === 'environment' && labelB.includes('back')) scoreB = 1;
                  if (preferredFacing === 'user' && labelA.includes('front')) scoreA = 1;
                  if (preferredFacing === 'user' && labelB.includes('front')) scoreB = 1;
                  if (scoreB !== scoreA) return scoreB - scoreA; // Higher score first
                  // Fallback sort by label
                  return labelA.localeCompare(labelB);
              });
             chooseCamSel.style.visibility = "visible";
             camDevices.forEach((mediaDevice, index) => {
                 const option = document.createElement('option');
                 option.value = mediaDevice.deviceId;
                 let label = mediaDevice.label || `Camera ${index + 1}`;
                  // Add hints if possible
                 if (mediaDevice.label.toLowerCase().includes('front')) label += " (Front)";
                 else if (mediaDevice.label.toLowerCase().includes('back')) label += " (Back)";
                 option.appendChild(document.createTextNode(label));
                 chooseCamSel.appendChild(option);
             });
             // Automatically select the first (potentially preferred) camera and update settings
             if (chooseCamSel.options.length > 0) {
                chooseCamSel.selectedIndex = 0;
                SelectCam();
             }
          } else {
              console.warn("No video input devices found.");
              chooseCamSel.style.visibility = "hidden";
          }
      } catch (err) {
          console.error("Error enumerating devices:", err);
          chooseCamSel.style.visibility = "hidden";
      }
  }
  function SelectCam(){
      var selectedDeviceId = chooseCamSel.value;
      var selectedLabel = chooseCamSel.options[chooseCamSel.selectedIndex]?.text || 'Selected Camera';
      // Update WEBCAM_SETTINGS
      // Use 'exact' constraint for deviceId. Clear facingMode to avoid conflicts.
      window.WEBCAM_SETTINGS.video = {
          ...(window.WEBCAM_SETTINGS.video || {}), // Keep existing settings like width/height
          deviceId: selectedDeviceId ? { exact: selectedDeviceId } : undefined,
          facingMode: undefined // Clear facingMode when specific device is chosen
      };
      console.log(`Selected Cam ID: ${selectedDeviceId}, Label: ${selectedLabel}`);
      console.log("Updated WEBCAM_SETTINGS:", JSON.stringify(window.WEBCAM_SETTINGS));
      if (window.iTracker) {
           iTracker.WEBCAM_NAME = selectedLabel;
      }
      // If webcam is already running, potentially restart it with the new selection?
      // This might be complex; usually selection happens before StartAR.
      // If needed later: stop, update settings, start again.
  }
  async function FlipCam(){
      console.log("FlipCam called");
      if (!arCamera || !window.webcamStream) {
          console.warn("Cannot flip camera, AR camera or stream not ready.");
          return;
      }
      arCamera.stopWebcam(); // Stop current stream first
      window.webcamStream.getTracks().forEach(track => track.stop()); // Ensure tracks are stopped
      window.webcamStream = null;
      // Toggle facingMode preference
		window.unityFacingMode = "environment"
      // Update WEBCAM_SETTINGS for the *next* getUserMedia call
      // Clear specific deviceId, set new facingMode
      window.WEBCAM_SETTINGS.video = {
         ...(window.WEBCAM_SETTINGS.video || {}),
         deviceId: undefined, // Clear specific device ID
         facingMode: window.unityFacingMode
      };
      // Update AR camera flip state based on new facing mode
      arCamera.setFlipped(window.unityFacingMode === 'user');
      console.log("Attempting to flip camera. New preferred facingMode:", window.unityFacingMode);
      console.log("Updated WEBCAM_SETTINGS for next start:", JSON.stringify(window.WEBCAM_SETTINGS));
      // Re-run the StartWebcam process which will now use the updated settings
      await StartWebcam(); // This will call getUserMedia with the new facingMode
  }
  async function IsCameraPermissionGranted() {
      // Best effort check using Permissions API
      if (!navigator.permissions || !navigator.mediaDevices) {
          console.warn("Permissions API or mediaDevices not supported. Cannot reliably check permission state beforehand.");
          return false; // Assume prompt needed or denied
      }
      try {
          const permissionStatus = await navigator.permissions.query({ name: "camera" });
          console.log("Camera permission status query result:", permissionStatus.state);
          return permissionStatus.state === "granted";
      } catch (error) {
          console.warn("Error checking camera permission (browser might not support query, e.g., Firefox):", error);
          // Cannot determine state, assume false (prompt will happen anyway if needed)
          return false;
      }
  }
  // --- UI Management ---
  function unityShowBanner(msg, type) {
    // (Keep the original banner logic)
    function updateBannerVisibility() {
      warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
    }
    var div = document.createElement('div');
    div.innerHTML = msg;
    warningBanner.appendChild(div);
    if (type == 'error') div.style = 'background: red; padding: 10px; color: white;';
    else {
      if (type == 'warning') div.style = 'background: yellow; padding: 10px; color: black;';
      setTimeout(function() {
        warningBanner.removeChild(div);
        updateBannerVisibility();
      }, 5000);
    }
    updateBannerVisibility();
  }
  function ShowError(error){
      console.error("Showing Error UI:", error);
      var errorDiv = document.getElementById("errorDiv");
      document.getElementById("errorText").innerHTML = error; // Use innerHTML for potential formatting
      errorDiv.style.opacity = 1;
      errorDiv.style.visibility = "visible";
      // Hide loading bar if it was visible
      if (loadingBar) loadingBar.style.display = 'none';
      // Optionally hide other UI elements like the start button if error is fatal
  }
  function ShowScreenshot(dataUrl){
      var screenshotDiv = document.getElementById("screenshotDiv");
      var img = document.getElementById("screenshotImg");
      img.onload = () => { // Adjust size after image loads
          const aspectRatio = img.naturalWidth / img.naturalHeight;
          const viewportWidth = window.innerWidth * 0.8; // 80vw
          const viewportHeight = window.innerHeight * 0.8; // 80vh
          if (viewportWidth / viewportHeight > aspectRatio) {
              // Viewport is wider than image aspect ratio -> height is limiting factor
              img.style.height = viewportHeight + 'px';
              img.style.width = (viewportHeight * aspectRatio) + 'px';
          } else {
              // Viewport is taller or equal aspect ratio -> width is limiting factor
              img.style.width = viewportWidth + 'px';
              img.style.height = (viewportWidth / aspectRatio) + 'px';
          }
          screenshotDiv.style.opacity = 1;
          screenshotDiv.style.visibility = "visible";
      };
      img.src = dataUrl; // Set src last
  }
  function HideScreenshot(){
      var screenshotDiv = document.getElementById('screenshotDiv');
      screenshotDiv.style.opacity = 0;
      // Visibility handled by CSS rule
  }
  function ShowVideoPreview(videoURL) {
        //  var videoPreviewDiv = document.getElementById('videoPreviewDiv');
        //  videoPreviewDiv.style.opacity = 1;
        //  videoPreviewDiv.style.visibility = 'visible';
          document.getElementById('cameraButtonContainer').style.display = "none";
         // const video = document.getElementById('videoPreview');
         //  video.src = videoURL;
         //  video.style.width = "80vw";
          // video.style.height = 80 / window.innerWidth * window.innerHeight + "vw";
      }
      function HideVideoPreview(){
       // var videoPreviewDiv = document.getElementById('videoPreviewDiv');
        var tapcontainer = document.getElementById('tap-container');
       // window.unityInstance.SendMessage('ARCamera', 'OnPreviewClosed');
          // videoPreviewDiv.style.opacity = 0;
           setTimeout(()=>{
            //  videoPreviewDiv.style.visibility = 'hidden';
              tapcontainer.style.opacity = 1;
              document.getElementById('cameraButtonContainer').style.display = "block";
            }, 500);
      }
  function ShowConfirmUrl(url){
      var confirmUrlDiv = document.getElementById("confirmUrlDiv");
      window.newUrlString = url; // Store URL globally for the button click
      // Sanitize URL display slightly for safety? Or display as is.
      document.getElementById("confirmUrlText").innerText = "Are you sure you want to visit " + url + "?";
      confirmUrlDiv.style.opacity = 1;
      confirmUrlDiv.style.visibility = "visible";
  }
  function HideConfirmUrl(){
      var confirmUrlDiv = document.getElementById("confirmUrlDiv");
      confirmUrlDiv.style.opacity = 0;
      // Visibility handled by CSS rule
  }
  // --- iTracker Globals (Example) ---
  window.ITRACKER_GLOBALS = {
      INTERNAL_SMOOTHFACTOR_POS: .075,
      // Add other global settings for iTracker if needed
  };
  // --- Placeholder functions for video actions (might be handled by Zappar) ---
  function downloadVideo() {
       console.log("Download button clicked (Implementation likely in Zappar/sns_custom.js)");
       // If not using Zappar's button, trigger download here:
       // const link = document.createElement('a');
       // link.href = document.getElementById('videoPreview').src;
       // link.download = 'WeWorkSticker_video.mp4';
       // document.body.appendChild(link);
       // link.click();
       // document.body.removeChild(link);
   }
   async function shareVideo() {
       console.log("Share button clicked (Implementation likely in Zappar/sns_custom.js)");
       // If not using Zappar's button, use Web Share API if available:
       // const videoSrc = document.getElementById('videoPreview').src;
       // try {
       //     const response = await fetch(videoSrc);
       //     const blob = await response.blob();
       //     const file = new File([blob], "WeWorkSticker_video.mp4", { type: blob.type });
       //     if (navigator.share && navigator.canShare({ files: [file] })) {
       //         await navigator.share({
       //             title: 'Check out my Video',
       //             text: 'Recorded using FilterYouAR',
       //             files: [file]
       //         });
       //         console.log('Successful share');
       //     } else {
       //         alert('Web Share API not supported or cannot share this file.');
       //         // Fallback: prompt user to download?
       //     }
       // } catch (error) {
       //     console.error('Error sharing', error);
       //     alert('Sharing failed: ' + error.message);
       // }
   }
  // --- Service Worker ---
  window.addEventListener("load", function () {
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("ServiceWorker.js")
          .then(reg => console.log("Service Worker registered.", reg))
          .catch(err => console.error("Service Worker registration failed:", err));
    }
    // Call initialize after page load and service worker registration attempt
    initialize();
  });
</script>
    </body>
  </html>
